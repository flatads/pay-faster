# 接入文档

## 一、准备工作
获取需要的mid的secret，由我方提供；
下载demo，将mid和secret填入demo中，运行测试。
## 二、接入配置
### 1. build.gradle
a. build.gradle(Project)

b. 添加相关依赖

c. 支付SDK版本配置如下，要求minSdkVersion为20

### 2. AndroidManifest.xml文件配置
a. 在配置中添加权限

b. 添加android:networkSecurityConfig

### 3. xml
a. 在app/src/main/res/xml文件夹下新建一个net_security_config.xml文件(如果没有xml文件夹，请新建一个)

## 三、接入支付
###1. 初始化
在AndroidManifest.xml进行Application的注册；
在Application的onCreate中进行支付SDK的初始化操作，如果需要，可以在此处进行自定义域名路径的配置。

### 2. 生成支付订单
由于部分支付方式的要求，请尽可能提供name和email。

### 3. 拉起支付
请务必在UI线程中调用

### 4. 接收支付结果
注意：此处的支付结果为支付SDK返回的支付结果，只可作为参考，实际的支付结果，以查询服务器结果为准，见【5. 查询支付结果】。
无论支付结果是成功还是失败还是取消，都必须查询支付结果来确认订单结果，因为部分支付不会在客户端返回支付结果，只会通过服务器回调支付结果。

### 5. 查询支付结果
支付结果状态码pay_status
code	含义
1	支付中
2	支付成功
3	支付失败
支付结果有两种方式获取，callback_url回调和通过查询订单详情接口查询。
#### 1. callback_url回调
在支付完成后，我方会根据接入方提供的callback_url通知接入方支付结果，如果通知失败，系统会进行重试，最多重试5次，5次都失败后不再通知，接入方的回调地址要做好幂等处理。请求以POST方式发出，参数以JSON格式放在requestBody中。
Params
order_id	支付订单号，该值由我方生成，返回给接入方，可根据该值查询订单
m_order_id	业务订单号，该值唯一值，不可重复。发起下单支付时生成，该值必须唯一，每次下单都是唯一的
p_order_id	支付供应商订单号
subscription_id	订阅号(续订用, 仅当使用订阅模式购买时, 才会传此参数, 一次性购买无此参数)
pay_type	支付类型（paytm，cashfree，mirapay）
pay_status	支付状态
msg	错误信息
checksum	签名（必填，生成方式见文档【3. 签名方式】, 强烈建议接入方要校验签名, 否则安全性无法保障）
Example Request


Response（收到回调后，固定回复以下json参数，如果回复的不是以下参数，则会进行重试, 最多重试5次）
Example Response 


#### 2. 查询订单详情接口
服务器和客户端均可通过此接口来查询订单详情。
环境	host
测试	http://api-test.gameschalo.com:8001
正式	https://pay.gameschalo.com
接口：/pay/order/get_order
请求方式：POST

Params
order_id	支付订单号（选填）
m_order_id	业务订单号（若order_id不填则此项必填，若order_id已填则此项不填）
mid	mid（必填）
checksum	签名(必填, 生成方式见文档【3. 签名方式】)

Example Request

Response
order_id	支付订单号
m_order_id	业务订单号
p_order_id	支付供应商订单号
pay_type	支付类型
pay_status	支付状态 1-支付中 2-支付成功 3-支付失败
ctime	创建时间
ptime	支付时间
order_name	订单名称
mid	mid

Example Response 

#### 3. 签名方式
将所有非空参数的值按照key的字母acii码值升序排列拼接起来，然后再拼接上secret形成签名串，再采用SHA256方式生成签名(结果转成16进制串,小写)

参数：
order_id=123456&m_order_id=m123456&p_order_id=p123456&pay_type=paytm&pay_status=2
secret: kjw239ho20w4jtofl23pgp24jfd3rb24
签名串=m123456123456p1234562paytmkjw239ho20w4jtofl23pgp24jfd3rb24
checksum=SHA256(签名串)=e342e1db47ef225501c49307df12c35f561ac21c32e72b71f2e4780d247d87cf

注意:生成签名必须在后端生成, 不可以在客户端或者web端生成, 并且秘钥只能保存在后端, 不能传递给客户端或者web端
### 6. 支付成功事件上报
支付成功后发放商品，同时上报支付成功事件，在UI线程执行，orderId为支付成功的对应的订单

## 四、异常问题
### 1. 常用支付异常信息
如果支付直接返回失败，可查看支付回调结果（PayServiceListener.onPayError）的PayError内容，检查code和msg。
### 2. Android 9.0 禁止明文传输问题
解决方法：参照【二、接入配置】的【3.b】和【4.a】。
### 3. minSdkVersion
由于PayU的minSdkVersion最低版本要求20，所以支付SDK的minSdkVersion要求20。
### 4. AndroidX
支付SDK升级到了AndroidX，接入时需要改成AndroidX的形式。
升级方式：https://www.jianshu.com/p/7dc111353328
详细对应表可以参考：https://blog.csdn.net/CsdnXiaoCaiJi/article/details/88088163
### 5. Manifest文件检查
配置完成后，检查Manifest文件是否合并无误。
打开工程主模块下的Manifest文件，检查aar中引入的组件是否存在。

如果没有存在，可能需要在manifest文件中的application节点添加tools:node="merge"即可。
如果依然没有aar中引入的组件存在，请与我们联系，我们提供技术支付。

### 6. android.content.ActivityNotFoundException: Unable to find explicit activity class
进行上面的Manifest文件检查，确保Manifest文件无误；
查看build.gradle文件，是否minifyEnable true，但没有设置proguardFiles。

### 7. 支付失败，报错"checksum is not valid"
接入支付时，通常都会遇到这个报错，原因一般有2：
接入方服务器下单生成checksum不对，生成是多了参数或者少了参数。遇到此问题，请检查生成checksum的逻辑是否正确。
测试环境正常，但正式环境发生此报错。请检查mid和secret，这两个参数的正式环境和测试环境有可能不一样。
### 8. 出现因为glide导致的崩溃
支付SDK使用的glide4.11，由于glide的4.8之前和4.9之后版本无法兼容，请升级glide到4.11版本。
### 9. 拉起支付后，出现崩溃信息：
Caused by: java.lang.NullPointerException: Attempt to invoke virtual method 'java.lang.String com.paymentgateway.paysdk.network.NetworkConfig.getServerHostTest()' on a null object reference
未进行SDK的初始化操作，参照【三、接入支付】的【1.初始化】操作，并在AndroidManifest.xml进行Application的注册。
### 10. 拉起支付后崩溃，出现崩溃信息：
java.lang.RuntimeException: Unable to start activity ComponentInfo{com.demo.mirapaydemo/com.paymentgateway.paysdk.pay.mvp.simple.NativePayActivity}: java.lang.IllegalStateException: You need to use a Theme.AppCompat theme (or descendant) with this activity.
请在styles.xml文件中添加以下内容。

### 11. 编译时失败提示：
Manifest merger failed : Attribute application@allowBackup value=(true) from AndroidManifest.xml:13:9-35 is also present at [com.payumoney.sdkui:plug-n-play:1.6.1] AndroidManifest.xml:17:9-36 value=(false).
Suggestion: add 'tools:replace="android:allowBackup"' to <application> element at AndroidManifest.xml:12:5-29:19 to override.
在AndroidManifest.xml中设置了android:allowBackup="true"，如果要保留为true，在Application中添加字段

或者将android:allowBackup="true"移除。
### 12. 接入完成后，拉起支付页面，卡在loading状态，请按照接入配置的3. AndroidManifest.xml文件配置添加相关的网络安全规则。
### 13. 接入完成后，点击支付，无反应，loading动画不出现，请使用UI线程拉起支付。
